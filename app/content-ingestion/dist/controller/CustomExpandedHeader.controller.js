sap.ui.define(["sap/ui/core/mvc/ControllerExtension","sap/m/MessageBox","sap/ui/core/BusyIndicator","sap/ui/core/Fragment","sap/m/Label","sap/m/Text","sap/m/HBox","sap/m/Panel","sap/m/VBox","./service"],function(e,t,o,n,a,s,i,r,c,l){"use strict";return e.extend("com.scb.treasury.contentingestion.controller.CustomExpandedHeader",{override:{onInit(){this.onfetchRoles();const e=new sap.ui.model.json.JSONModel;this.getView().setModel(e,"viewModel");this.getView().getModel("viewModel").setProperty("/decision")},onTableActionPress:function(e){debugger;console.log("Meta Data");sap.m.MessageToast.show("Meta Data")}},onTypeMismatch:function(){t.error("Only pdf, docx, xlsx files are allowed")},onBeforeActionExecution:function(e){const t=e.getParameter("action");if(t==="CatalogService.approveContent"||t==="CatalogService.rejectContent"){return new Promise((e,o)=>{sap.m.MessageBox.warning("Are you sure you want to "+(t.includes("approve")?"approve":"reject")+" this content?",{title:"Confirm Action",actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],emphasizedAction:sap.m.MessageBox.Action.OK,onClose:function(t){if(t===sap.m.MessageBox.Action.OK){e()}else{o()}}})})}},onfetchRoles:async function(e){const t=sap.ui.require.toUrl("com/scb/treasury/contentingestion");const o=t+"/user-api/currentUser";try{const e=await fetch(o,{method:"GET",headers:{"Content-Type":"application/json"}});if(!e.ok){throw new Error(`HTTP error! Status: ${e.status}`)}const t=await e.json();const n=t.scopes;const a=n.some(e=>e.includes("ContentChecker"));const s=n.some(e=>e.includes("ContentMaker"));const i=new sap.ui.model.json.JSONModel({isAdmin:a,isViewer:s});this.getView().setModel(i,"authModel");console.log("Auth model created:",i.getData())}catch(e){console.error("API Error:",e)}},_getBaseURL:function(){const e=sap.ui.core.Component.getOwnerComponentFor(this.base.getView()).getManifestEntry("/sap.app/id").replaceAll(".","/");return sap.ui.require.toUrl(e)},onfetchCSRF:async function(e){const t=await fetch(e,{method:"HEAD",credentials:"include",headers:{"X-CSRF-Token":"Fetch"}});const o=t.headers.get("X-CSRF-Token");if(!o){throw new Error("Failed to fetch CSRF token")}return o},_getText:function(e,t){return this.base.getOwnerComponent().getModel("i18n").getResourceBundle().getText(e,t)},onFileChange:function(e){console.log("Inside File Change");const t=e.getSource();const o=e.getParameter("files")[0];if(o){console.log("File selected: ",o.name)}},calculateFileHash:async function(e){const t=await e.arrayBuffer();const o=await crypto.subtle.digest("SHA-256",t);const n=Array.from(new Uint8Array(o));return n.map(e=>e.toString(16).padStart(2,"0")).join("")},onOpenDialog:function(e){var t=this;var o=e.metadata;if(!o){return}o["filename"]=e.filename;this.getView().getModel("viewModel").setData(o);if(!this._oDialog){this._pDialog=n.load({id:this.getView().getId()+"--myDialog",name:"com.scb.treasury.contentingestion.fragment.MyDialog",controller:this}).then(function(e){t._oDialog=e;t.getView().addDependent(e);t._oDialog.open()})}else{t._oDialog.open()}return true},onCloseDialog:function(){this._oDialog.close()},onUploadFile:async function(){try{o.show(0);sap.m.MessageToast.show("opening dialog box");const e=this.base.byId("__fileUploader");const t=e.getDomRef("fu").files[0];const n=sap.ui.require.toUrl("com/scb/treasury/contentingestion");const a=n+"/api/upload";const s=await this.onfetchCSRF(n);console.log(t);let i=new FormData;i.append("file",t);if(!t){sap.m.MessageToast.show("Please select a file to upload.");return}const r=await fetch(a,{method:"POST",headers:{"X-CSRF-Token":s},body:i});if(!r.ok){sap.m.MessageToast.show(r.message);return}const c=await r.json();const l=await this.onOpenDialog(c);const d=c.metadata.processing_decision;this.getView().getModel("viewModel").setProperty("/decision",d);if(l){if(d=="REJECTED")return;else{const o=await this.calculateFileHash(t);const a=c.metadata;if(e.getValue()){e.setValueState("None");const i=n+"/odata/v4/catalog/Content/"+o+"/content";const r=n+"/odata/v4/catalog/Content";const l=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":s},credentials:"include",body:JSON.stringify({ID:`${o}`,fileName:t.name,url:i,status:"SUBMITTED",metaData:JSON.stringify({metadata:a})})});if(!l.ok){if(l.status===400){sap.m.MessageToast.show("400-Bad Request");return}else{throw new Error(`Entity creation failed: ${l.status}`)}}const d=await this.saveMetaData(s,c.metadata,t.name);const u=this.base.getExtensionAPI().getModel();await fetch(i,{method:"PUT",headers:{"Content-Type":t.type,Slug:encodeURIComponent(t.name),"X-CSRF-Token":s},credentials:"include",body:t});u.refresh();e.setValue("")}else{e.setValueState("Error")}}}}catch(e){console.error(e);t.error(this._getText("fileUploadError"),{details:e})}finally{o.hide()}},_readFileAsBase64:function(e){return new Promise((t,o)=>{const n=new FileReader;n.onload=e=>t(e.target.result.split(",")[1]);n.onerror=o;n.readAsDataURL(e)})},_postInitialFileRecord:async function(e,t,o){try{const n=this.getView().getModel();const a=sap.ui.require.toUrl("com/scb/treasury/contentingestion")+"Content('"+o+"')/content";const s=await l.createContent(this.base,{initialData:JSON.stringify(e)},"CatalogService.EntityContainer/createContent",n);if(s){const e=this.base.getExtensionAPI().getModel();await fetch(a,{method:"PUT",headers:{"Content-Type":t.type,Slug:encodeURIComponent(t.name),"X-CSRF-Token":csrfToken},credentials:"include",body:t});e.refresh()}}catch(e){this._handleException(e,"_postInitialInvoiceRecord")}},_handleException:function(e,o){const n=e instanceof Error?{"Error Location":o,name:e.name,message:e.message,stack:e.stack}:{"Error Location":o,...e};console.error("Handled Error:",n);t.error("An unexpected error occurred.")},_populateJsonData:function(e){const t=this.getView().getId();const o=n.byId(t,"headerSection");const r=n.byId(t,"technicalSection");const c=n.byId(t,"additionalSection");[o,r,c].forEach(e=>{const t=e.getItems().slice(1);t.forEach(t=>e.removeItem(t))});const l=(e,t)=>new i({items:[new a({text:e+":",design:"Bold",wrapping:true}),new s({text:t||"Not available",wrapping:true,class:"sapUiTinyMarginBegin"})],class:"sapUiSmallMarginBottom"});Object.entries(e.header).forEach(([e,t])=>o.addItem(l(e,t)));Object.entries(e.technical).forEach(([e,t])=>r.addItem(l(e,t)));Object.entries(e.additional).forEach(([e,t])=>{if(typeof t==="object"&&t!==null){Object.entries(t).forEach(([t,o])=>{c.addItem(l(`${e}.${t}`,o))})}else{c.addItem(l(e,t))}})},saveMetaData:function(e,t,o){const n=sap.ui.require.toUrl("com/scb/treasury/contentingestion")+"/odata/v4/catalog/MetaDataForFiles";const a=fetch(n,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":e},credentials:"include",body:JSON.stringify({fileName:o,metaData:JSON.stringify({json:t})})});return a}})});
//# sourceMappingURL=CustomExpandedHeader.controller.js.map