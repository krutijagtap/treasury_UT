sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/m/PDFViewer","sap/m/BusyDialog","sap/m/MessageToast"],(e,t,s,n,o)=>{"use strict";return e.extend("treasuryui.controller.TreasuryMainView",{onInit(){let e=new sap.ui.model.json.JSONModel;this.getView().setModel(e,"treasuryModel")},onfetchCSRF:async function(e){const t=await fetch(e,{method:"GET",headers:{"X-CSRF-Token":"Fetch"}});const s=t.headers.get("X-CSRF-Token");if(!s){throw new Error("Failed to fetch CSRF token")}return s},onSelectDocument:function(e){var t=e.getSource();var s=t.getSelectedItems();var n=s.map(function(e){return"File: "+e.getText()});n.push("Question: ");var o=n.join("\n");this.byId("chatFeedInput").setValue(o)},onUserChat:async function(){const e=this.getOwnerComponent().getModel("chatModel");const t=this.getView();const s=this.byId("chatFeedInput").getValue();var n=this.byId("multiCombo").getSelectedItems();const o=s.toLowerCase().includes("intellibase")||n.length>0;e.setSubmit(false);e.setvisibleResult(false);const a=new sap.m.BusyDialog({title:"Busy Indicator",text:"Generating response. Please standby.."});a.open();t.setBusy(true);await Promise.resolve();try{const t=await this.onfetchData(s,o);e.setResult(t);e.setvisibleResult(true);console.log(t);return t}catch(e){console.error("Chat fetch error:",e);sap.m.MessageToast.show("Failed to get response.")}finally{a.close();t.setBusy(false)}},onfetchData:async function(e,s){const n=this.getBaseUrl()+"/api/chat";const o=this.fetchCsrfToken();const a=this.byId("pdfContainer");a.removeAllItems();const r=new AbortController;const i=setTimeout(()=>{r.abort()},9e4);if(!s){t.error("Please select a file or Ask Intellibase");return}const c={message:"user_id: 1623894:"+e};try{const e=await fetch(n,{method:"POST",headers:{"X-CSRF-Token":o,"Content-Type":"application/json"},body:JSON.stringify(c),signal:r.signal});clearTimeout(i);if(!e.ok){throw new Error(`HTTP error! Status: ${e.status}`)}const t=await e.json();const s=t.FINAL_RESULT+"<h3>SQL Query Used:</h3>"+"<pre style='font-family: monospace; white-space: pre-wrap;'>"+t.SQL_QUERY+"</pre>";const l=new sap.m.FormattedText({htmlText:s});a.addItem(l);console.log("API Response:",s);return a}catch(e){console.log("inside catch of askFinsight",e)}},onGenerateSummary:async function(e){var s=this.byId("multiCombo").getSelectedItems();var n=this.byId("chatFeedInput");if(s.length>1||s.length==0){t.error("Please select a single file to Generate Summary.");return}var o=s[0].getText();n.setValue(`Research Summary: ${o}`);this._callSummaryApi("Research Summary: C-PressRelease-2Q25.pdf",o)},getBaseUrl:function(){return sap.ui.require.toUrl("treasuryui")},fetchCsrfToken:async function(){let e=this.getBaseUrl();const t=await fetch(e,{method:"HEAD",credentials:"include",headers:{"X-CSRF-Token":"Fetch"}});const s=t.headers.get("X-CSRF-Token");return s},_callSummaryApi:async function(e,t){const s=new n({text:"Fetching summary..."});s.open();const a=this.getOwnerComponent().getModel("chatModel");const r=this.getBaseUrl()+"/api/chat";const i=this.fetchCsrfToken();const c={message:"Research Summary: "+t};a.setSubmit(false);a.setvisibleResult(false);try{const e=await fetch(r,{method:"POST",headers:{"X-CSRF-Token":i,"Content-Type":"application/json"},body:JSON.stringify(c)});if(!e.ok){throw new Error(`HTTP error! Status: ${e.status}`)}const t=await e.json();if(t.success&&Array.isArray(t.summary_files)){var l=this._displayPdfFiles(t.summary_files);s.close();a.setResult(l);a.setvisibleResult(true);return l}else{o.show("No summaries returned.")}}catch(e){console.log("inside catch of generate summary",e)}},_displayPdfFiles:function(e){const t=this.byId("pdfContainer");t.removeAllItems();e.forEach(e=>{const s=this._createPdfViewer(e.data,e.filename);t.addItem(s)});return t},_createPdfViewer:function(e,t){const s=atob(e);const n=new Uint8Array(s.length);for(let e=0;e<s.length;e++){n[e]=s.charCodeAt(e)}const o=new Blob([n],{type:"application/pdf"});const a=URL.createObjectURL(o);const r=new sap.m.Button({icon:"sap-icon://download",tooltip:"Download PDF",type:"Transparent",press:function(){const e=document.createElement("a");e.href=a;e.download=t;e.click()}});return new sap.m.Panel({headerText:t,width:"100%",height:"250vh",content:[r,new sap.ui.core.HTML({content:`<iframe src="${a}" class="pdf-iframe" style="width: 100%; height: 150vh;"></iframe>`})],layoutData:new sap.m.FlexItemData({growFactor:1})})}})});
//# sourceMappingURL=TreasuryMainView.controller.js.map