sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/m/PDFViewer","sap/m/BusyDialog","sap/m/MessageToast"],(e,t,s,n,o)=>{"use strict";return e.extend("treasuryui.controller.TreasuryMainView",{onInit(){let e=new sap.ui.model.json.JSONModel;this.getView().setModel(e)},onfetchCSRF:async function(e){const t=await fetch(e,{method:"GET",headers:{"X-CSRF-Token":"Fetch"}});const s=t.headers.get("X-CSRF-Token");if(!s){throw new Error("Failed to fetch CSRF token")}return s},onSelectDocument:function(e){var t=e.getSource();var s=t.getSelectedItems();var n=s.map(function(e){return"File: "+e.getText()});n.push("Question: ");var o=n.join("\n");this.byId("chatFeedInput").setValue(o)},onUserChat:async function(){const e=this.getOwnerComponent().getModel("chatModel");const t=this.getView();const s=this.byId("chatFeedInput").getValue();e.setSubmit(false);e.setvisibleResult(false);const n=new sap.m.BusyDialog({title:"Busy Indicator",text:"Generating response. Please standby.."});n.open();t.setBusy(true);await Promise.resolve();try{const t=await this.onfetchData(s);e.setResult(t);e.setvisibleResult(true);console.log(t);return t}catch(e){console.error("Chat fetch error:",e);sap.m.MessageToast.show("Failed to get response.")}finally{n.close();t.setBusy(false)}},onfetchData:async function(e){const t=this.getBaseUrl()+"/api/chat";const s=this.fetchCsrfToken();const n=this.byId("pdfContainer");n.removeAllItems();const o=new AbortController;const a=setTimeout(()=>{o.abort()},9e4);const r={message:"Intellibase: What is the total RWA in UK for end of December 2024"};try{const e=await fetch(t,{method:"POST",headers:{"X-CSRF-Token":s,"Content-Type":"application/json"},body:JSON.stringify(r),signal:o.signal});clearTimeout(a);if(!e.ok){throw new Error(`HTTP error! Status: ${e.status}`)}const i=await e.json();const c=i.FINAL_RESULT;const l=new sap.m.FormattedText({htmlText:c});n.addItem(l);console.log("API Response:",c);return n}catch(e){console.log("inside catch of askFinsight",e)}},onGenerateSummary:async function(e){var s=this.byId("multiCombo").getSelectedItems();var n=this.byId("chatFeedInput");if(s.length>1||s.length==0){t.error("Please select a single file to Generate Summary.");return}var o=s[0].getText();n.setValue(`Research Summary: ${o}`);this._callSummaryApi("Research Summary: C-PressRelease-2Q25.pdf")},getBaseUrl:function(){return sap.ui.require.toUrl("treasuryui")},fetchCsrfToken:async function(){let e=this.getBaseUrl();const t=await fetch(e,{method:"HEAD",credentials:"include",headers:{"X-CSRF-Token":"Fetch"}});const s=t.headers.get("X-CSRF-Token");return s},_callSummaryApi:async function(e){const t=new n({text:"Fetching summary..."});t.open();const s=this.getOwnerComponent().getModel("chatModel");const a=this.getBaseUrl()+"/api/chat";const r=this.fetchCsrfToken();const i={message:"Research Summary: C-PressRelease-2Q25.pdf"};s.setSubmit(false);s.setvisibleResult(false);try{const e=await fetch(a,{method:"POST",headers:{"X-CSRF-Token":r,"Content-Type":"application/json"},body:JSON.stringify(i)});if(!e.ok){throw new Error(`HTTP error! Status: ${e.status}`)}const n=await e.json();if(n.success&&Array.isArray(n.summary_files)){var c=this._displayPdfFiles(n.summary_files);t.close();s.setResult(c);s.setvisibleResult(true);return c}else{o.show("No summaries returned.")}}catch(e){console.log("inside catch of generate summary",e)}},_displayPdfFiles:function(e){const t=this.byId("pdfContainer");t.removeAllItems();e.forEach(e=>{const s=this._createPdfViewer(e.data,e.filename);t.addItem(s)});return t},_createPdfViewer:function(e,t){const s=atob(e);const n=new Uint8Array(s.length);for(let e=0;e<s.length;e++){n[e]=s.charCodeAt(e)}const o=new Blob([n],{type:"application/pdf"});const a=URL.createObjectURL(o);return new sap.m.PDFViewer({source:a,title:t,width:"100%",height:"600px"})}})});
//# sourceMappingURL=TreasuryMainView.controller.js.map